rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // --- Helper Functions ---

    // Check if user is a member of the project
    function isProjectMember(projectId) {
      let project = get(/databases/$(database)/documents/projects/$(projectId));
      return project != null && (
        project.data.memberIds.hasAny([request.auth.uid]) || 
        (project.data.invitedMemberIds != null && project.data.invitedMemberIds.hasAny([request.auth.uid]))
      );
    }
    
    // Check if user is the OWNER of the project
    function isProjectOwner(projectId) {
      let project = get(/databases/$(database)/documents/projects/$(projectId));
      return project != null && project.data.ownerId == request.auth.uid;
    }

    // Validate Project Schema on Create
    function isValidNewProject() {
      let data = request.resource.data;
      return data.keys().hasAll(['name', 'key', 'ownerId', 'memberIds'])
        && data.name is string && data.name.size() > 0
        && data.key is string && data.key.size() > 0
        && data.ownerId == request.auth.uid
        && data.memberIds.hasAll([request.auth.uid]);
    }

    // Validate Issue Schema
    function isValidIssue() {
      let data = request.resource.data;
      // Basic checks: title exists and is not empty, type is valid
      return data.title is string && data.title.size() > 0
             && (!data.keys().hasAny(['type']) || data.type in ['story', 'bug', 'task']);
    }

    // Prevent changing immutable fields (projectId)
    function notChangingProjectId() {
      return request.resource.data.projectId == resource.data.projectId;
    }

    // --- Rules ---

    match /projects/{projectId} {
      // Read: Users can read a project if they are in the memberIds list OR invitedMemberIds
      allow read: if signedIn() && (
        resource.data.memberIds.hasAny([request.auth.uid]) ||
        (resource.data.invitedMemberIds != null && resource.data.invitedMemberIds.hasAny([request.auth.uid]))
      );
      
      // Strict Create: Must set self as owner and member
      allow create: if signedIn() && isValidNewProject();
      
      // Update:
      // 1. Members can update basic fields (name, key)
      // 2. Owner has full write (can change memberIds, etc)
      // 3. Invited users can update ONLY to remove themselves from invitedMemberIds and add to memberIds (Accept) or remove from invitedMemberIds (Reject)
      //    For simplicity in this MVP: We allow update if you are a member OR invited. 
      //    Ideally we would strictly validate *what* you are changing (e.g. only moving your own ID).
      allow update: if signedIn() && (
        resource.data.ownerId == request.auth.uid || 
        (
          // Existing members can update (but mostly we want them to not change critical auth fields, dealt with in logic or tighter rules later)
          resource.data.memberIds.hasAny([request.auth.uid]) 
        ) ||
        (
          // Invited users can update (to accept/reject)
          resource.data.invitedMemberIds.hasAny([request.auth.uid])
        )
      );
      
      allow delete: if signedIn() && resource.data.ownerId == request.auth.uid;
    }

    match /boards/{boardId} {
      allow read: if signedIn() && isProjectMember(resource.data.projectId);
      allow create: if signedIn() && isProjectMember(request.resource.data.projectId);
      // Prevent changing project ID
      allow update: if signedIn() && isProjectMember(resource.data.projectId) && notChangingProjectId();
      allow delete: if signedIn() && isProjectMember(resource.data.projectId);
    }

    match /issues/{issueId} {
      allow read: if signedIn() && (
        resource.data.assigneeId == request.auth.uid || 
        isProjectMember(resource.data.projectId)
      );

      allow create: if signedIn() 
                    && isProjectMember(request.resource.data.projectId)
                    && isValidIssue();

      allow update: if signedIn() 
                    && isProjectMember(resource.data.projectId)
                    && notChangingProjectId()
                    && isValidIssue();

      allow delete: if signedIn() && isProjectMember(resource.data.projectId);
    }

    match /users/{uid} {
      allow read: if signedIn();
      allow write: if signedIn() && request.auth.uid == uid;
    }
  }
}
