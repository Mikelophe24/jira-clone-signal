rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // --- Helper Functions ---

    // Check if user is a member of the project
    function isProjectMember(projectId) {
      let project = get(/databases/$(database)/documents/projects/$(projectId));
      return project != null && (
        project.data.memberIds.hasAny([request.auth.uid]) || 
        (project.data.invitedMemberIds != null && project.data.invitedMemberIds.hasAny([request.auth.uid]))
      );
    }
    
    // Check if user is the OWNER of the project
    function isProjectOwner(projectId) {
      let project = get(/databases/$(database)/documents/projects/$(projectId));
      return project != null && project.data.ownerId == request.auth.uid;
    }

    // Validate Project Schema on Create
    function isValidNewProject() {
      let data = request.resource.data;
      return data.keys().hasAll(['name', 'key', 'ownerId', 'memberIds'])
        && data.name is string && data.name.size() > 0
        && data.key is string && data.key.size() > 0
        && data.ownerId == request.auth.uid
        && data.memberIds.hasAll([request.auth.uid]);
    }

    // Validate Issue Schema
    function isValidIssue() {
      let data = request.resource.data;
      // Basic checks: title exists and is not empty, type is valid
      return data.title is string && data.title.size() > 0
             && (!data.keys().hasAny(['type']) || data.type in ['story', 'bug', 'task']);
    }

    // Prevent changing immutable fields (projectId)
    function notChangingProjectId() {
      return request.resource.data.projectId == resource.data.projectId;
    }

    // --- Rules ---

    match /projects/{projectId} {
      // Read: Users can read a project if they are in the memberIds list OR invitedMemberIds
      allow read: if signedIn() && (
        resource.data.memberIds.hasAny([request.auth.uid]) ||
        (resource.data.invitedMemberIds != null && resource.data.invitedMemberIds.hasAny([request.auth.uid]))
      );
      
      // Strict Create: Must set self as owner and member
      allow create: if signedIn() && isValidNewProject();
      
      // Update:
      // 1. Owner has full write (except changing ownerId to keep it simple)
      // 2. Members/Invited users can update ONLY non-restricted fields (cannot change name, key, or ownerId)
      allow update: if signedIn() && (
        resource.data.ownerId == request.auth.uid || 
        (
          (
            resource.data.memberIds.hasAny([request.auth.uid]) ||
            (resource.data.invitedMemberIds != null && resource.data.invitedMemberIds.hasAny([request.auth.uid]))
          ) &&
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['name', 'key', 'ownerId'])
        )
      );
      
      allow delete: if signedIn() && resource.data.ownerId == request.auth.uid;
    }


    match /issues/{issueId} {
      allow read: if signedIn() && (
        resource.data.assigneeId == request.auth.uid || 
        isProjectMember(resource.data.projectId)
      );

      allow create: if signedIn() 
                    && isProjectMember(request.resource.data.projectId)
                    && isValidIssue();

      allow update: if signedIn() 
                    && isProjectMember(resource.data.projectId)
                    && notChangingProjectId()
                    && (
                      // 1. Assignee, Reporter hoặc Project Owner có quyền sửa mọi thứ
                      (
                        resource.data.assigneeId == request.auth.uid || 
                        resource.data.reporterId == request.auth.uid || 
                        isProjectOwner(resource.data.projectId)
                      ) ||
                      // 2. Member bình thường CHỈ được phép đổi status và order (kéo thả)
                      // Chặn thay đổi title, description, priority, type...
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['title', 'description', 'type', 'priority', 'reporterId', 'key'])
                    );

      allow delete: if signedIn() && (
        resource.data.reporterId == request.auth.uid || 
        isProjectOwner(resource.data.projectId)
      );
    }

    match /users/{uid} {
      allow read: if signedIn();
      allow write: if signedIn() && request.auth.uid == uid;
    }
  }
}
